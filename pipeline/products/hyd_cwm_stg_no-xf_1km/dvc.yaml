params:
  - params.yaml

stages:
  ######################################################################################
  # RES-IND., PFT-DEP. STAGES ----------------------------------------------------------
  ######################################################################################

  build_gbif_maps:
    cmd: >-
      python ${project_root}/stages/build_gbif_maps.py
      --params params.yaml
      --partitions milan genoa
      --cpus 61
      --mem 350GB
      --time 00:30:00
    deps:
      - ${project_root}/src/data/build_gbif_map.py
      - ${project_root}/data/interim/gbif/filtered_occurrences/hydraulic/gbif_filtered.parquet
      - ${project_root}/${traits.interim_out}
    outs:
      - ${project_root}/${gbif.maps.out_dir}/${product_code}:
          persist: false 

  build_splot_maps:
    cmd: >-
      python ${project_root}/stages/build_splot_maps.py
      --params params.yaml
      --partitions milan genoa
      --cpus 2
      --mem 256GB
      --time 00:30:00
    deps:
      - ${project_root}/src/data/build_splot_map.py
      - ${project_root}/data/interim/splot/filtered_surveys/hydraulic/splot_filtered.parquet
      - ${project_root}/${traits.interim_out}
    outs:
      - ${project_root}/${splot.maps.out_dir}/${product_code}:
          persist: false

  build_y:
    cmd: >-
      python ${project_root}/stages/build_y.py
      --params params.yaml
      --partitions milan genoa
      --time 01:00:00
      --cpus 4
      --mem 64GB
      --merge-cpus 9
      --merge-mem 400GB
    deps:
      - ${project_root}/stages/build_y.py
      - ${project_root}/src/features/build_y_trait.py
      - ${project_root}/src/features/merge_y_traits.py
      - ${project_root}/${gbif.maps.out_dir}/${product_code}
      - ${project_root}/${splot.maps.out_dir}/${product_code}
    params:
      - traits.names
      - datasets.Y.trait_stat
      - train.dir
      - train.Y.fn
      - product_code
    outs:
      - ${project_root}/${train.dir}/${product_code}/${train.Y.fn}:
          persist: false

  calculate_spatial_autocorr:
    cmd: >-
      python ${project_root}/stages/calc_spatial_autocorr.py
      --params params.yaml
      --partition l40s
      --gpus 1
      --time 0:10:00
    deps:
      - ${project_root}/src/features/calc_spatial_autocorr_gpu.py
      - ${project_root}/${train.dir}/${product_code}/${train.Y.fn}
    params:
      - spatial_autocorr.ranges_fp
    outs:
      - ${project_root}/${spatial_autocorr.ranges_fp}

  build_cv_splits:
    cmd: >-
      python ${project_root}/stages/build_cv_splits.py
      --params params.yaml
      --partitions genoa
      --cpus 100
      --mem 64GB
      --time 00:20:00
    deps:
      - ${project_root}/stages/build_cv_splits.py
      - ${project_root}/src/features/build_cv_splits.py
      - ${project_root}/${train.Y.fp}
      - ${project_root}/${spatial_autocorr.ranges_fp}
    params:
      - train.cv_splits
      - train.Y.fp
      - spatial_autocorr.ranges_fp
    outs:
      - ${project_root}/${train.cv_splits.dir_fp}:
          persist: true

  prepare_xy_data:
    cmd: python ${project_root}/stages/prepare_xy_data.py --params params.yaml --partition milan --cpus 64 --mem 128GB
    deps:
      - ${project_root}/stages/prepare_xy_data.py
      - ${project_root}/${train.predict.fp}
      - ${project_root}/${train.Y.fp}
      - ${project_root}/${train.cv_splits.dir_fp}
    params:
      - train.xy_data.fp
      - train.Y.fp
      - train.predict.fp
      - train.cv_splits.dir_fp
    outs:
      - ${project_root}/${train.xy_data.fp}:
          persist: true

  train_models:
    cmd: python ${project_root}/stages/train_models.py --params params.yaml --partitions milan genoa --cpus 96 --mem 30GB --gpus 0
    deps:
      - ${project_root}/stages/train_models.py
      - ${project_root}/src/models/autogluon.py
      - ${project_root}/${train.xy_data.fp}
      - ${project_root}/${train.cv_splits.dir_fp}
    params:
      - train.arch
      - train.trait_sets
      - train.cv_splits.n_splits
      - train.weights
      - train.eval_results
      - train.feature_importance
      - autogluon
      - models.dir_fp
    outs:
      - ${project_root}/${models.dir_fp}:
          persist: true

  # aggregate_cv_stats:
  #   cmd: python ${project_root}/stages/aggregate_cv_stats.py --params params.yaml
  #   deps:
  #     - ${project_root}/stages/aggregate_cv_stats.py
  #     - ${project_root}/${models.dir_fp}
  #   params:
  #     - train.eval_results
  #     - train.feature_importance
  #   outs:
  #     - ${project_root}/${models.dir_fp}/aggregated_stats:
  #         persist: false
  
  # aoa:
  #   cmd: python src/analysis/aoa.py
  #   deps:
  #     - src/analysis/aoa.py
  #     - ${train.dir}/${PFT}/${model_res}/${train.Y.fn}
  #     - ${train.dir}/${eo_data.predict.dir}/${model_res}/${eo_data.predict.imputed_fn}
  #     - ${models.dir}/${PFT}/${model_res}  # Feature importance
  #   params:
  #     - datasets.Y.traits
  #     - aoa
  #   outs:
  #     - ${processed.dir}/${PFT}/${model_res}/${aoa.dir}:
  #         persist: true

  # predict:
  #   cmd: python src/models/predict_traits.py -r -v
  #   deps:
  #     - src/models/predict_traits.py
  #     - ${train.dir}/${eo_data.predict.dir}/${model_res}/${eo_data.predict.imputed_fn}
  #     - ${train.dir}/${eo_data.predict.dir}/${model_res}/${eo_data.predict.mask_fn}
  #     - ${models.dir}/${PFT}/${model_res}
  #     - ${interim_dir}/${trydb.interim.dir}/${trydb.interim.transformer_fn}
  #   params:
  #     - predict
  #   outs:
  #     - ${processed.dir}/${PFT}/${model_res}/${predict.dir}:
  #         persist: true

  # cov:
  #   cmd: python src/models/predict_traits.py -r -v --cov
  #   deps:
  #     - src/models/predict_traits.py
  #     - ${train.dir}/${eo_data.predict.dir}/${model_res}/${eo_data.predict.imputed_fn}
  #     - ${train.dir}/${eo_data.predict.dir}/${model_res}/${eo_data.predict.mask_fn}
  #     - ${models.dir}/${PFT}/${model_res}
  #     - ${interim_dir}/${trydb.interim.dir}/${trydb.interim.transformer_fn}
  #   params:
  #     - predict
  #     - cov
  #   outs:
  #     - ${processed.dir}/${PFT}/${model_res}/${cov.dir}:
  #         persist: true

  # build_final_product:
  #   cmd: python src/data/build_final_product.py -o
  #   deps:
  #     - src/data/build_final_product.py
  #     - reference/trait_mapping.json
  #     - reference/trait_stat_mapping.json
  #     - ${processed.dir}/${PFT}/${model_res}/${predict.dir}
  #     - ${processed.dir}/${PFT}/${model_res}/${cov.dir}
  #     - ${processed.dir}/${PFT}/${model_res}/${aoa.dir}
  #   params:
  #     - public
  #   outs:
  #     - ${processed.dir}/${PFT}/${model_res}/${public.local_dir}:
  #         persist: true

  # aggregate_all_stats:
  #   cmd: python src/models/multires_stats.py -mfc
  #   deps:
  #     - src/models/multires_stats.py
  #     - ${models.dir}/${PFT}/${model_res}
  #   params:
  #     - analysis
  
  # aggregate_aoa:
  #   cmd: python src/analysis/multires_aoa.py
  #   deps:
  #     - src/analysis/multires_aoa.py
  #     - ${processed.dir}/${PFT}/${model_res}/${aoa.dir}
  
  # other_product_splot_correlation:
  #   cmd: python src/analysis/other_product_splot_correlation.py
  #   deps:
  #     - src/analysis/other_product_splot_correlation.py
  #     - ${interim_dir}/other_trait_maps
  #     - ${interim_dir}/${splot.interim.dir}/${splot.interim.traits}/${PFT}/${model_res}