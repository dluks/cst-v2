Bootstrap: docker
From: python:3.11-slim

%post
    # Install system dependencies including minimal MPI for building mpi4py
    apt-get update && apt-get install -y \
        git \
        wget \
        curl \
        build-essential \
        r-base \
        r-base-dev \
        r-recommended \
        python3-dev \
        && rm -rf /var/lib/apt/lists/*

    # Install Poetry
    pip install poetry

    # Configure Poetry to not create a virtual environment
    poetry config virtualenvs.create true
    poetry config virtualenvs.in-project true

%files
    pyproject.toml /app/
    poetry.lock /app/
    params.yaml /app/
    README.md /app/

%post
    # Create data directory for binding
    mkdir /app/data
    mkdir /app/models
    mkdir /app/src
    mkdir /app/tests
    mkdir /app/reference
    mkdir /app/results
    
    cd /app

    # Fix potential lock file issues first
    poetry lock || true
    
    # Install dependencies with specific options to handle problematic packages
    poetry install \
        --no-interaction \
        --no-ansi \
        --with cuda \
        --with r \
        --with profiling \
        --without dev \
        --no-root

%environment
    # Standard environment variables
    export PYTHONUNBUFFERED=1
    export PYTHONPATH=/app:$PYTHONPATH
    export PROJECT_ROOT=/app
    
%runscript
    #!/bin/bash
    cd /app # Ensure we're in the project directory
    exec "$@"