schema: '2.0'
stages:
  standardize_other_products:
    cmd: python src/data/standardize_other_products.py
    deps:
    - path: data/raw/other-trait-maps
      hash: md5
      md5: 4e2634f828ab66f4fe29d28e5e9db7cf.dir
      size: 32055984651
      nfiles: 1509
    - path: src/data/standardize_other_products.py
      hash: md5
      md5: 392228f98044cd552c75c66d2c8c2e73
      size: 4659
    outs:
    - path: data/interim/other_trait_maps
      hash: md5
      md5: 4ce80d8ff95ecdcbad3f7738ed93d461.dir
      size: 1183362520
      nfiles: 63
  build_container:
    cmd: stages/build_container.sh singularity cit-sci-traits latest cit-sci-traits.def
      cit-sci-traits.sif
    deps:
    - path: README.md
      hash: md5
      md5: c255f86c149ea407ee916b3eb75be456
      size: 9726
    - path: cit-sci-traits.def
      hash: md5
      md5: a9ece716692785bb77a429cccfd774d0
      size: 1465
    - path: poetry.lock
      hash: md5
      md5: b311fbb31797269f8d56bfa3db0d66c1
      size: 672611
    - path: pyproject.toml
      hash: md5
      md5: abb62da99ab8238dbfd94f6814da0866
      size: 1732
    - path: stages/build_container.sh
      hash: md5
      md5: 52742d9dcb076bd83a511a755757a5f3
      size: 917
      isexec: true
    params:
      params.yaml:
        container:
          type: singularity
          name: cit-sci-traits
          docker_tag: latest
          def: cit-sci-traits.def
          image: cit-sci-traits.sif
    outs:
    - path: cit-sci-traits.sif
      hash: md5
      md5: 2168f356be5b96afb1549bb3bec41a15
      size: 20662411264
  get_TRY_mean_traits:
    cmd: stages/get_TRY_mean_traits.sh singularity cit-sci-traits latest cit-sci-traits.sif
      "poetry run python src/data/build_try_traits.py"
    deps:
    - path: src/data/build_try_traits.py
      hash: md5
      md5: 43a9bbe7465c7c9d9ce363ae6e44d790
      size: 15084
    params:
      params.yaml:
        PFT: Grass
        try_version: 6
        trydb:
          raw:
            try6:
              dir: TRY_6_gapfilled_for_distribution
              zip: TRY6_gapfilled_for_distribution.zip
              zipfile_csv: TRY6_gapfilled_for_distribution/TRY6_gapfilled_filtered_2.csv.zip
            try5:
              dir: TRY_5_GapFilledData_2020
              zip: TRY_5_GapFilledData_2020.zip
              zipfile_csv: 
                TRY_50_2020_01/gapfilled_data/mean_gap_filled_back_transformed_incl_species_names.csv
            pfts: try_pft_v2.parquet
          interim:
            dir: try
            quantile_range:
            transform: power
            already_norm:
            filtered: traits.parquet
            transformer_fn: power_transformer.pkl
            perform_pca: false
            pca_n_components: 4
            pca_fn: no_pca.pkl
    outs:
    - path: data/interim/try/no_pca.pkl
      hash: md5
      md5: d41d8cd98f00b204e9800998ecf8427e
      size: 19421545
    - path: data/interim/try/power_transformer.pkl
      hash: md5
      md5: 3af58b921bc9e9fe73758f2337be08b1
      size: 2163
    - path: data/interim/try/traits.parquet
      hash: md5
      md5: 104c0200f41f91ca4be7973dccdc234f
      size: 4473730
  match_gbif_pfts:
    cmd: stages/match_gbif_pfts.sh singularity cit-sci-traits latest cit-sci-traits.sif
      "poetry run python src/data/match_gbif_pfts.py"
    deps:
    - path: data/raw/all_tracheophyta_non-cult_2024-04-10
      hash: md5
      md5: ada860692d425bd047bd09fd4531fdbf.dir
      size: 30005038638
      nfiles: 1584
    - path: data/raw/try_pft_v2.parquet
      hash: md5
      md5: d49a4b1611eebbd529c9e9aba6aa5f69
      size: 2232209
    - path: src/data/match_gbif_pfts.py
      hash: md5
      md5: 957225b51ba6d03bb35139a7fabc6059
      size: 3375
    params:
      params.yaml:
        PFT: Grass
        datasets.Y.gbif: all_tracheophyta_non-cult_2024-04-10
        gbif.interim.dir: gbif
        gbif.interim.matched: gbif_pfts.parquet
        gbif.raw.dir: all_tracheophyta_non-cult_2024-04-10
    outs:
    - path: data/interim/gbif/gbif_pfts.parquet
      hash: md5
      md5: c7504b332aaf296efab1598be6bfbf61.dir
      size: 2938908051
      nfiles: 159
  extract_splot:
    cmd: stages/extract_splot.sh singularity cit-sci-traits latest cit-sci-traits.sif
      "poetry run python src/data/extract_splot.py"
    deps:
    - path: data/raw/splot4-0
      hash: md5
      md5: 99990a51d13fe4485f72dd03590d44a6.dir
      size: 521575464
      nfiles: 3
    - path: src/data/extract_splot.py
      hash: md5
      md5: 5f916a29bb82cc2d228bcac2a6d853c0
      size: 3203
    params:
      params.yaml:
        datasets.Y.splot: splot4-0
        splot.interim.dir: splot
    outs:
    - path: data/interim/splot/extracted
      hash: md5
      md5: 79e5388fb25a0c2fa5af8eb08c26498e.dir
      size: 508142149
      nfiles: 3
  harmonize_eo_data:
    cmd: python src/data/harmonize_eo_data.py
    deps:
    - path: src/data/harmonize_eo_data.py
      hash: md5
      md5: 364b84bb720f57c2eadf2bd47e1b987d
      size: 8078
    params:
      params.yaml:
        base_resolution: 55000
        datasets.X:
          canopy_height: ETH_GlobalCanopyHeight_2020_v1_1km
          modis: modis_sur_refl_monthly_avg_1km
          soilgrids: soilgrids_v2-0_1km
          vodca: vodca_mean-p5-p95_1km
          worldclim: wc2-1_30s_bio
        eo_data.interim.dir: eo_data
        mask:
          path: data/raw/esa_worldcover_v100_1km/esa_worldcover_v100_1km.tif
          keep_classes:
          - 10
          - 20
          - 30
          - 40
          - 60
          - 70
          - 90
          - 95
          - 100
        model_res: 55km
        target_resolution: 55000
        worldclim.bio_vars:
        - '1'
        - '4'
        - '7'
        - '12'
        - 13-14
        - '15'
    outs:
    - path: data/interim/eo_data/55km
      hash: md5
      md5: 10252a0aaa6d27dc0d7d939a7d1dbcba.dir
      size: 14279660
      nfiles: 150
  build_predict:
    cmd: python src/features/featurize_predict.py
    deps:
    - path: data/interim/eo_data/55km
      hash: md5
      md5: 10252a0aaa6d27dc0d7d939a7d1dbcba.dir
      size: 14279660
      nfiles: 150
    - path: src/features/featurize_predict.py
      hash: md5
      md5: 507a3cdc24f7b6d2de56726a9a5559ae
      size: 5020
    params:
      params.yaml:
        eo_data.interim.dir: eo_data
        eo_data.predict.dir: predict
        eo_data.predict.imputed_fn: eo_predict_imputed.parquet
        eo_data.predict.mask_fn: eo_predict_mask.parquet
        model_res: 55km
        train.dir: data/features
    outs:
    - path: data/features/predict/55km/eo_predict_imputed.parquet
      hash: md5
      md5: 2c314baaded50a8949b8fef26c2de020
      size: 11107078
    - path: data/features/predict/55km/eo_predict_mask.parquet
      hash: md5
      md5: 1ad3cfece7a07456126cb939a4e088f4
      size: 229806
  build_gbif_maps:
    cmd: stages/build_gbif_maps_parallel.sh
    deps:
    - path: data/interim/gbif/gbif_pfts.parquet
      hash: md5
      md5: c7504b332aaf296efab1598be6bfbf61.dir
      size: 2938908051
      nfiles: 159
    - path: data/interim/try/traits.parquet
      hash: md5
      md5: 104c0200f41f91ca4be7973dccdc234f
      size: 4473730
    - path: src/data/build_gbif_maps.py
      hash: md5
      md5: 10b87d47b292ec29a06ac126c3cc3ad9
      size: 8524
    params:
      params.yaml:
        PFT: Grass
        datasets.Y.gbif: all_tracheophyta_non-cult_2024-04-10
        datasets.Y.traits:
        - 3106
        - 3117
        gbif.interim.dir: gbif
        model_res: 55km
        target_resolution: 55000
        trydb.interim.dir: try
        trydb.interim.filtered: traits.parquet
    outs:
    - path: data/interim/gbif/trait_maps/Grass/55km
      hash: md5
      md5: 4f777a3914faa4fa861a2ba0494b281c.dir
      size: 3161890
      nfiles: 2
  build_splot_maps:
    cmd: stages/build_splot_maps_parallel.sh
    deps:
    - path: data/interim/splot/extracted
      hash: md5
      md5: 79e5388fb25a0c2fa5af8eb08c26498e.dir
      size: 508142149
      nfiles: 3
    - path: data/interim/try/traits.parquet
      hash: md5
      md5: 104c0200f41f91ca4be7973dccdc234f
      size: 4473730
    - path: data/raw/try_pft_v2.parquet
      hash: md5
      md5: d49a4b1611eebbd529c9e9aba6aa5f69
      size: 2232209
    - path: src/data/build_splot_maps.py
      hash: md5
      md5: 0804aba6b6c2354f1de09649526dc29d
      size: 14145
    params:
      params.yaml:
        PFT: Grass
        datasets.Y.traits:
        - 3106
        - 3117
        model_res: 55km
        splot.interim:
          dir: splot
          extracted: extracted
          traits: trait_maps
        target_resolution: 55000
    outs:
    - path: data/interim/splot/trait_maps/Grass/55km
      hash: md5
      md5: 0c3ddd402ec2811f2c27f5a9030b558e.dir
      size: 1138162
      nfiles: 2
  build_y:
    cmd: stages/build_y.sh singularity cit-sci-traits latest cit-sci-traits.sif "poetry
      run python src/features/build_y.py"
    deps:
    - path: data/interim/gbif/trait_maps/Grass/55km
      hash: md5
      md5: 4f777a3914faa4fa861a2ba0494b281c.dir
      size: 3161890
      nfiles: 2
    - path: data/interim/splot/trait_maps/Grass/55km
      hash: md5
      md5: 0c3ddd402ec2811f2c27f5a9030b558e.dir
      size: 1138162
      nfiles: 2
    - path: src/features/build_y.py
      hash: md5
      md5: 4c4a7d0eac0ec2344b0d262f9a7743f8
      size: 4408
    params:
      params.yaml:
        datasets.Y.trait_stat: 1
        datasets.Y.traits:
        - 3106
        - 3117
    outs:
    - path: data/features/Grass/55km/Y.parquet
      hash: md5
      md5: cd4a5854e5bdb5d0e22f4031bf910da3.dir
      size: 2240676
      nfiles: 260
