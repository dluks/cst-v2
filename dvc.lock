schema: '2.0'
stages:
  standardize_other_products:
    cmd: python src/data/standardize_other_products.py
    deps:
    - path: data/raw/other-trait-maps
      hash: md5
      md5: 848dac77f0897cf7e58f41a196fe1d68.dir
      size: 32055985074
      nfiles: 1510
    - path: src/data/standardize_other_products.py
      hash: md5
      md5: 2e4c967cc9dda5883850576253521e00
      size: 4665
    outs:
    - path: data/interim/other_trait_maps
      hash: md5
      md5: 4ce80d8ff95ecdcbad3f7738ed93d461.dir
      size: 1183362520
      nfiles: 63
  build_container:
    cmd: stages/build_container.sh singularity cit-sci-traits latest cit-sci-traits.def
      cit-sci-traits.sif
    deps:
    - path: README.md
      hash: md5
      md5: c255f86c149ea407ee916b3eb75be456
      size: 9726
    - path: cit-sci-traits.def
      hash: md5
      md5: a9ece716692785bb77a429cccfd774d0
      size: 1465
    - path: poetry.lock
      hash: md5
      md5: 8f7cfac13e06acaf604d74b7951ca402
      size: 667727
    - path: pyproject.toml
      hash: md5
      md5: abb62da99ab8238dbfd94f6814da0866
      size: 1732
    - path: stages/build_container.sh
      hash: md5
      md5: 52742d9dcb076bd83a511a755757a5f3
      size: 917
      isexec: true
    params:
      params.yaml:
        container:
          type: singularity
          name: cit-sci-traits
          docker_tag: latest
          def: cit-sci-traits.def
          image: cit-sci-traits.sif
    outs:
    - path: cit-sci-traits.sif
      hash: md5
      md5: 2168f356be5b96afb1549bb3bec41a15
      size: 20662411264
      isexec: true
  get_TRY_mean_traits:
    cmd: stages/get_TRY_mean_traits.sh singularity cit-sci-traits latest cit-sci-traits.sif
      "poetry run python src/data/build_try_traits.py"
    deps:
    - path: src/data/build_try_traits.py
      hash: md5
      md5: d3879d5fb8804ea19af493949990f275
      size: 15089
    params:
      params.yaml:
        PFT: Shrub_Tree_Grass
        try_version: 5
        trydb:
          raw:
            try6:
              dir: TRY_6_gapfilled_for_distribution
              zip: TRY6_gapfilled_for_distribution.zip
              zipfile_csv: TRY6_gapfilled_for_distribution/TRY6_gapfilled_filtered_2.csv.zip
            try5:
              dir: TRY_5_GapFilledData_2020
              zip: TRY_5_GapFilledData_2020.zip
              zipfile_csv: 
                TRY_50_2020_01/gapfilled_data/mean_gap_filled_back_transformed_incl_species_names.csv
            pfts: try_pft_v2.parquet
          interim:
            dir: try
            quantile_range:
            - 0.005
            - 0.995
            transform: norm
            already_norm:
            filtered: traits.parquet
            transformer_fn: norm_scaler.pkl
            perform_pca: true
            pca_n_components: 0.5
            pca_fn: trait_pca.pkl
    outs:
    - path: data/interim/try/norm_scaler.pkl
      hash: md5
      md5: e9cbab77d1f8619b812039a6410f7a4f
      size: 1420
    - path: data/interim/try/trait_pca.pkl
      hash: md5
      md5: c7d560abf85efe52d8de85216731804c
      size: 2304
    - path: data/interim/try/traits.parquet
      hash: md5
      md5: 9286b2e6c494ff099ab0ae5e3ba32800
      size: 1828448
  match_gbif_pfts:
    cmd: stages/match_gbif_pfts.sh singularity cit-sci-traits latest cit-sci-traits.sif
      "poetry run python src/data/match_gbif_pfts.py"
    deps:
    - path: data/raw/all_tracheophyta_non-cult_2024-04-10
      hash: md5
      md5: ada860692d425bd047bd09fd4531fdbf.dir
      size: 30005038638
      nfiles: 1584
    - path: data/raw/try_pft_v2.parquet
      hash: md5
      md5: d49a4b1611eebbd529c9e9aba6aa5f69
      size: 2232209
    - path: src/data/match_gbif_pfts.py
      hash: md5
      md5: 957225b51ba6d03bb35139a7fabc6059
      size: 3375
    params:
      params.yaml:
        PFT: Shrub_Tree_Grass
        datasets.Y.gbif: all_tracheophyta_non-cult_2024-04-10
        gbif.interim.dir: gbif
        gbif.interim.matched: gbif_pfts.parquet
        gbif.raw.dir: all_tracheophyta_non-cult_2024-04-10
    outs:
    - path: data/interim/gbif/gbif_pfts.parquet
      hash: md5
      md5: 84c01f5bca440b2901ac096cd577ed11.dir
      size: 4022072469
      nfiles: 159
  extract_splot:
    cmd: stages/extract_splot.sh singularity cit-sci-traits latest cit-sci-traits.sif
      "poetry run python src/data/extract_splot.py"
    deps:
    - path: data/raw/splot4-0
      hash: md5
      md5: 99990a51d13fe4485f72dd03590d44a6.dir
      size: 521575464
      nfiles: 3
    - path: src/data/extract_splot.py
      hash: md5
      md5: 5f916a29bb82cc2d228bcac2a6d853c0
      size: 3203
    params:
      params.yaml:
        datasets.Y.splot: splot4-0
        splot.interim.dir: splot
    outs:
    - path: data/interim/splot/extracted
      hash: md5
      md5: 79e5388fb25a0c2fa5af8eb08c26498e.dir
      size: 508142149
      nfiles: 3
  build_splot_maps:
    cmd: stages/build_splot_maps_parallel.sh
    deps:
    - path: data/interim/splot/extracted
      hash: md5
      md5: 79e5388fb25a0c2fa5af8eb08c26498e.dir
      size: 508142149
      nfiles: 3
    - path: data/interim/try/traits.parquet
      hash: md5
      md5: 9286b2e6c494ff099ab0ae5e3ba32800
      size: 1828448
    - path: data/raw/try_pft_v2.parquet
      hash: md5
      md5: d49a4b1611eebbd529c9e9aba6aa5f69
      size: 2232209
    - path: src/data/build_splot_maps.py
      hash: md5
      md5: d39d1da13ddd7674bc48b3c5b64606ef
      size: 14108
    params:
      params.yaml:
        PFT: Shrub_Tree_Grass
        datasets.Y.traits:
        - 4
        - 6
        - 11
        - 13
        - 14
        - 15
        - 18
        - 21
        - 26
        - 27
        - 46
        - 47
        - 50
        - 55
        - 78
        - 95
        - 138
        - 144
        - 145
        - 146
        - 163
        - 169
        - 237
        - 281
        - 282
        - 289
        - 1080
        - 3113
        - 3120
        - 1000
        model_res: 1km
        splot.interim:
          dir: splot
          extracted: extracted
          traits: trait_maps
        target_resolution: 1000
    outs:
    - path: data/interim/splot/trait_maps/Shrub_Tree_Grass/1km
      hash: md5
      md5: 326b6d157894bf1fe1734b1113db66c2.dir
      size: 10587079
      nfiles: 1
  build_gbif_maps:
    cmd: stages/build_gbif_maps_parallel.sh
    deps:
    - path: data/interim/gbif/gbif_pfts.parquet
      hash: md5
      md5: 84c01f5bca440b2901ac096cd577ed11.dir
      size: 4022072469
      nfiles: 159
    - path: data/interim/try/traits.parquet
      hash: md5
      md5: 9286b2e6c494ff099ab0ae5e3ba32800
      size: 1828448
    - path: src/data/build_gbif_maps.py
      hash: md5
      md5: 5d277f3e4f93cda17e82ad9f4bf486fd
      size: 8624
    params:
      params.yaml:
        PFT: Shrub_Tree_Grass
        datasets.Y.gbif: all_tracheophyta_non-cult_2024-04-10
        datasets.Y.traits:
        - 4
        - 6
        - 11
        - 13
        - 14
        - 15
        - 18
        - 21
        - 26
        - 27
        - 46
        - 47
        - 50
        - 55
        - 78
        - 95
        - 138
        - 144
        - 145
        - 146
        - 163
        - 169
        - 237
        - 281
        - 282
        - 289
        - 1080
        - 3113
        - 3120
        - 1000
        gbif.interim.dir: gbif
        model_res: 1km
        target_resolution: 1000
        trydb.interim.dir: try
        trydb.interim.filtered: traits.parquet
    outs:
    - path: data/interim/gbif/trait_maps/Shrub_Tree_Grass/1km
      hash: md5
      md5: 198f7f89d02634b1d7ad5e92609ee74d.dir
      size: 38024113
      nfiles: 1
  build_y:
    cmd: stages/build_y.sh singularity cit-sci-traits latest cit-sci-traits.sif poetry
      run python src/features/build_y.py
    deps:
    - path: data/interim/gbif/trait_maps/Shrub_Tree_Grass/1km
      hash: md5
      md5: 198f7f89d02634b1d7ad5e92609ee74d.dir
      size: 38024113
      nfiles: 1
    - path: data/interim/splot/trait_maps/Shrub_Tree_Grass/1km
      hash: md5
      md5: 326b6d157894bf1fe1734b1113db66c2.dir
      size: 10587079
      nfiles: 1
    - path: src/features/build_y.py
      hash: md5
      md5: 4c4a7d0eac0ec2344b0d262f9a7743f8
      size: 4408
    params:
      params.yaml:
        datasets.Y.trait_stat: 1
        datasets.Y.traits:
        - 1000
    outs:
    - path: data/features/Shrub_Tree_Grass/1km/Y.parquet
      hash: md5
      md5: ae52c5ce97c9009dbb07235e764d2461.dir
      size: 29006593
      nfiles: 44
