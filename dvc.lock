schema: '2.0'
stages:
  standardize_other_products:
    cmd: python src/data/standardize_other_products.py
    deps:
    - path: data/raw/other-trait-maps
      hash: md5
      md5: 4e2634f828ab66f4fe29d28e5e9db7cf.dir
      size: 32055984651
      nfiles: 1509
    - path: src/data/standardize_other_products.py
      hash: md5
      md5: 392228f98044cd552c75c66d2c8c2e73
      size: 4659
    outs:
    - path: data/interim/other_trait_maps
      hash: md5
      md5: 4ce80d8ff95ecdcbad3f7738ed93d461.dir
      size: 1183362520
      nfiles: 63
  get_TRY_mean_traits:
    cmd: python src/data/build_try_traits.py
    deps:
    - path: data/raw/TRY_6_gapfilled_for_distribution/TRY6_gapfilled_for_distribution.zip
      hash: md5
      md5: f2cc4a7dd419bed117f42e62780b16e8
      size: 307941318
    - path: src/data/build_try_traits.py
      hash: md5
      md5: 4591adf83bc478f9c90d6357b8e0f852
      size: 5673
    params:
      params.yaml:
        trydb:
          raw:
            dir: TRY_6_gapfilled_for_distribution
            zip: TRY6_gapfilled_for_distribution.zip
            zipfile_csv: TRY6_gapfilled_for_distribution/TRY6_gapfilled_filtered_2.csv.zip
            pfts: try_pft_v2.parquet
          interim:
            dir: try
            quantile_range:
            transform: power
            already_norm:
            filtered: traits.parquet
            transformer_fn: power_transformer.pkl
    outs:
    - path: data/interim/try/power_transformer.pkl
      hash: md5
      md5: 56c46ca6411ddfd4ac490a28b3ad12b4
      size: 2163
    - path: data/interim/try/traits.parquet
      hash: md5
      md5: 1c0ff1ba06e5a8ce7de4590483280220
      size: 6079896
  match_gbif_pfts:
    cmd: python src/data/match_gbif_pfts.py
    deps:
    - path: data/raw/all_tracheophyta_non-cult_2024-04-10
      hash: md5
      md5: ada860692d425bd047bd09fd4531fdbf.dir
      size: 30005038638
      nfiles: 1584
    - path: data/raw/try_pft_v2.parquet
      hash: md5
      md5: d49a4b1611eebbd529c9e9aba6aa5f69
      size: 2232209
    - path: src/data/match_gbif_pfts.py
      hash: md5
      md5: 3df32335940ce1cd561f810db81ebc7d
      size: 2556
    params:
      params.yaml:
        datasets.Y.gbif: all_tracheophyta_non-cult_2024-04-10
        gbif.interim.dir: gbif
        gbif.interim.matched: gbif_pfts.parquet
        gbif.raw.dir: all_tracheophyta_non-cult_2024-04-10
    outs:
    - path: data/interim/gbif/gbif_pfts.parquet
      hash: md5
      md5: 3588c721bb421ef1f67c9a9c00b72c49.dir
      size: 4026649735
      nfiles: 159
  extract_splot:
    cmd: python src/data/extract_splot.py
    deps:
    - path: data/raw/splot4-0
      hash: md5
      md5: 99990a51d13fe4485f72dd03590d44a6.dir
      size: 521575464
      nfiles: 3
    - path: src/data/extract_splot.py
      hash: md5
      md5: 2a89310e584294f1661965d542a50d18
      size: 3108
    params:
      params.yaml:
        datasets.Y.splot: splot4-0
        splot.interim.dir: splot
    outs:
    - path: data/interim/splot/extracted
      hash: md5
      md5: 79e5388fb25a0c2fa5af8eb08c26498e.dir
      size: 508142149
      nfiles: 3
  harmonize_eo_data:
    cmd: python src/data/harmonize_eo_data.py
    deps:
    - path: src/data/harmonize_eo_data.py
      hash: md5
      md5: 364b84bb720f57c2eadf2bd47e1b987d
      size: 8078
    params:
      params.yaml:
        base_resolution: 1000
        datasets.X:
          canopy_height: ETH_GlobalCanopyHeight_2020_v1_1km
          modis: modis_sur_refl_monthly_avg_1km
          soilgrids: soilgrids_v2-0_1km
          vodca: vodca_mean-p5-p95_1km
          worldclim: wc2-1_30s_bio
        eo_data.interim.dir: eo_data
        mask:
          path: data/raw/esa_worldcover_v100_1km/esa_worldcover_v100_1km.tif
          keep_classes:
          - 10
          - 20
          - 30
          - 40
          - 60
          - 70
          - 90
          - 95
          - 100
        model_res: 1km
        target_resolution: 1000
        worldclim.bio_vars:
        - '1'
        - '4'
        - '7'
        - '12'
        - 13-14
        - '15'
    outs:
    - path: data/interim/eo_data/1km
      hash: md5
      md5: f647487e3ff8b6aed0d0c49eac9613be.dir
      size: 30797034288
      nfiles: 150
  build_predict:
    cmd: python src/features/featurize_predict.py
    deps:
    - path: data/interim/eo_data/1km
      hash: md5
      md5: f647487e3ff8b6aed0d0c49eac9613be.dir
      size: 30797034288
      nfiles: 150
    - path: src/features/featurize_predict.py
      hash: md5
      md5: ca3da443b6f09c8a58773d046fa54dca
      size: 5035
    params:
      params.yaml:
        eo_data.interim.dir: eo_data
        eo_data.predict.dir: predict
        eo_data.predict.imputed_fn: eo_predict_imputed.parquet
        eo_data.predict.mask_fn: eo_predict_mask.parquet
        model_res: 1km
        train.dir: data/features
    outs:
    - path: data/features/predict/1km/eo_predict_imputed.parquet
      hash: md5
      md5: 9372b044d0d211e6450b9bee0b772100
      size: 28557279604
    - path: data/features/predict/1km/eo_predict_mask.parquet
      hash: md5
      md5: a5b2d37a18df4f9d1ebcc60484d413d0
      size: 529921831
  build_gbif_maps:
    cmd: python src/data/build_gbif_maps.py
    deps:
    - path: data/interim/gbif/gbif_pfts.parquet
      hash: md5
      md5: 3588c721bb421ef1f67c9a9c00b72c49.dir
      size: 4026649735
      nfiles: 159
    - path: data/interim/try/traits.parquet
      hash: md5
      md5: 1c0ff1ba06e5a8ce7de4590483280220
      size: 6079896
    - path: src/data/build_gbif_maps.py
      hash: md5
      md5: 58efa57b08c69d098fdcb0207b7b4252
      size: 4065
    params:
      params.yaml:
        PFT: Shrub_Tree
        datasets.Y.gbif: all_tracheophyta_non-cult_2024-04-10
        gbif.interim.dir: gbif
        model_res: 1km
        target_resolution: 1000
        trydb.interim.dir: try
        trydb.interim.filtered: traits.parquet
    outs:
    - path: data/interim/gbif/trait_maps/Shrub_Tree/1km
      hash: md5
      md5: ede3cccffc02425b20e53a22d9df5a01.dir
      size: 2569240781
      nfiles: 31
  build_splot_maps:
    cmd: python src/data/build_splot_maps.py
    deps:
    - path: data/interim/splot/extracted
      hash: md5
      md5: 79e5388fb25a0c2fa5af8eb08c26498e.dir
      size: 508142149
      nfiles: 3
    - path: data/interim/try/traits.parquet
      hash: md5
      md5: 1c0ff1ba06e5a8ce7de4590483280220
      size: 6079896
    - path: data/raw/try_pft_v2.parquet
      hash: md5
      md5: d49a4b1611eebbd529c9e9aba6aa5f69
      size: 2232209
    - path: src/data/build_splot_maps.py
      hash: md5
      md5: c8c6b1d35dfeb304bae62f2e6710b03c
      size: 9272
    params:
      params.yaml:
        PFT: Shrub_Tree
        model_res: 1km
        splot.interim:
          dir: splot
          extracted: extracted
          traits: trait_maps
        target_resolution: 1000
    outs:
    - path: data/interim/splot/trait_maps/Shrub_Tree/1km
      hash: md5
      md5: da0669886e7068b0944733e43decc7cf.dir
      size: 1023998799
      nfiles: 31
  build_y:
    cmd: python src/features/build_y.py
    deps:
    - path: data/interim/gbif/trait_maps/Shrub_Tree/1km
      hash: md5
      md5: ede3cccffc02425b20e53a22d9df5a01.dir
      size: 2569240781
      nfiles: 31
    - path: data/interim/splot/trait_maps/Shrub_Tree/1km
      hash: md5
      md5: da0669886e7068b0944733e43decc7cf.dir
      size: 1023998799
      nfiles: 31
    - path: src/features/build_y.py
      hash: md5
      md5: 5c636d0f1fe3fb3afd2d61c9b056b8cd
      size: 4335
    params:
      params.yaml:
        datasets.Y.trait_stat: 1
        datasets.Y.traits:
        - 4
        - 6
        - 13
        - 14
        - 15
        - 21
        - 26
        - 27
        - 46
        - 47
        - 50
        - 55
        - 78
        - 95
        - 138
        - 144
        - 145
        - 146
        - 163
        - 169
        - 237
        - 281
        - 282
        - 289
        - 297
        - 614
        - 1080
        - 3106
        - 3113
        - 3117
        - 3120
    outs:
    - path: data/features/Shrub_Tree/1km/Y.parquet
      hash: md5
      md5: 559690c5a075fabd7c0aa52b97bec88c.dir
      size: 421443528
      nfiles: 44
  calculate_spatial_autocorr:
    cmd: python src/features/calc_spatial_autocorr_gpu.py
    deps:
    - path: data/features/Shrub_Tree/1km/Y.parquet
      hash: md5
      md5: 559690c5a075fabd7c0aa52b97bec88c.dir
      size: 421443528
      nfiles: 44
    - path: src/features/calc_spatial_autocorr.py
      hash: md5
      md5: 66dbc61b038a0d82f63d1dd1ffd298ce
      size: 10631
    params:
      params.yaml:
        calc_spatial_autocorr:
          use_existing: false
        train.spatial_autocorr: spatial_autocorr.parquet
    outs:
    - path: data/features/Shrub_Tree/1km/spatial_autocorr.parquet
      hash: md5
      md5: 5de834538a6d27f68383263cc302c5ac
      size: 7472
  build_cv_splits:
    cmd: python src/features/skcv_splits.py -o
    deps:
    - path: data/features/Shrub_Tree/1km/Y.parquet
      hash: md5
      md5: 559690c5a075fabd7c0aa52b97bec88c.dir
      size: 421443528
      nfiles: 44
    - path: data/features/Shrub_Tree/1km/spatial_autocorr.parquet
      hash: md5
      md5: 5de834538a6d27f68383263cc302c5ac
      size: 7472
    - path: src/features/skcv_splits.py
      hash: md5
      md5: a17ab9d0efe98b372ddc6042a074cd91
      size: 10734
    params:
      params.yaml:
        train.cv_splits:
          range_stat: median
          n_splits: 5
          n_sims: 200
          dir: skcv_splits
    outs:
    - path: data/features/Shrub_Tree/1km/skcv_splits
      hash: md5
      md5: 23348efe6e9abe25a995ce5afb6b71ba.dir
      size: 154174708
      nfiles: 31
